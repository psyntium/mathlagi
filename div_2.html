<!doctype html>
<html lang="en" class="h-100">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>MathLagi v0.1 - Division - Level 2</title>

    <!-- Bootstrap core CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">

    <meta name="theme-color" content="#7952b3">


    <style>
        body {
            text-shadow: 0 .05rem .1rem rgba(0, 0, 0, .5);
            box-shadow: inset 0 0 5rem rgba(0, 0, 0, .5);
        }

        .cover-container {
            max-width: 42em;
        }

        .nav-link {
            font-weight: 700;
            color: rgba(255, 255, 255, .5);
            background-color: transparent;
        }

        .num_hint {
            top: 10%;
            left: 10%;
        }

        .answer {
            right: 10%;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Firefox */
        input[type=number] {
            -moz-appearance: textfield;
        }

        .border-dashed {
            border-style: dashed!important;;
        }
        
    </style>
</head>

<body class="d-flex h-100 bg-dark text-white text-center user-select-none">

    <div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column">
        <header class="mb-auto">
            <div class="border-bottom border-1">
                <h3 class="float-md-start mb-0">MathLagi : <span class="font-monospace">&divide;</span> : <span class="font-monospace">2</span></h3>
                
                <nav class="nav justify-content-end">
                    <a id="btnHome" class="nav-link ps-0" href="index.html"><i class="bi-house"></i> Home</a>
                    <a id="btnLevel" class="nav-link ps-0" href="div.html"><i class="bi-speedometer"></i> Level</a>
                    <a id="btnReset" class="nav-link ps-0" href="#"><i class="bi-arrow-clockwise"></i> Reset</a>
                    <a id="btnSubmitAll" class="nav-link ps-0" href="#"><i class="bi-send"></i> Done</a>
                </nav>
            </div>

            <div class="border-bottom border-1 pt-1 pb-0">
                <div class="row">
                    <div id="timer" class="col h4 align-self-start text-start">&nbsp;</div>
                    <div id="posQ"  class="col h4 align-self-center text-center">&nbsp;</div>
                    <div id="score" class="col h4 align-self-end text-end">&nbsp;</div>
                </div>
            </div>
        </header>

        <main class="overflow-auto px-3">
            <div id="math-content" class="font-monospace my-5">

                <div class="row">
                    <div class="col">&nbsp;</div>
                    <div class="col">&nbsp;</div>
                    <div class="col">&nbsp;</div>
                    <div class="col position-relative border border-1 border-dashed border-secondary">
                        <input id="a1_2" type="number" class="bg-dark text-white form-control text-center border-0 p-0" pattern="[0-9]*" inputmode="numeric" maxlength="1" max="9" min="0"/>
                        <span class="position-absolute top-0 answer text-danger"></span>
                    </div>
                    <div class="col position-relative border border-1 border-dashed border-secondary">
                        <input id="a1_1" type="number" class="bg-dark text-white form-control text-center border-0 p-0" pattern="[0-9]*" inputmode="numeric" maxlength="1" max="9" min="0"/>
                        <span class="position-absolute top-0 answer text-danger"></span>
                    </div>
                    <div id="mark1" class="col"></div>
                </div>
                <div class="row">
                    <div class="col-2"><span id="l2_2" class="num">&nbsp;</span></div>
                    <div class="col-2"><span id="l2_1" class="num">&nbsp;</span></div>
                    <div class="col-2 border-top border-start border-5"><span id="l1_3" class="num">&nbsp;</span></div>
                    <div class="col-2 border-top border-5"><span id="l1_2" class="num">&nbsp;</span></div>
                    <div class="col-2 border-top border-5"><span id="l1_1" class="num">&nbsp;</span></div>
                    <div class="col-1">&nbsp;</div>
                </div>
                <div class="row">
                    <div class="col"></div>
                    <div class="col text-secondary">&minus;</div>
                    <div class="col position-relative border border-1 border-dashed border-secondary">
                        <input id="a2_3" type="number" class="bg-dark text-white form-control text-center border-0 p-0" pattern="[0-9]*" inputmode="numeric" maxlength="1" max="9" min="0"/>
                        <span class="position-absolute top-0 answer text-danger"></span>
                    </div>
                    <div class="col position-relative border border-1 border-dashed border-secondary">
                        <input id="a2_2" type="number" class="bg-dark text-white form-control text-center border-0 p-0" pattern="[0-9]*" inputmode="numeric" maxlength="1" max="9" min="0"/>
                        <span class="position-absolute top-0 answer text-danger"></span>
                    </div>
                    <div class="col position-relative border border-1 border-dashed border-secondary">
                        <input id="a2_1" type="number" class="bg-dark text-white form-control text-center border-0 p-0" pattern="[0-9]*" inputmode="numeric" maxlength="1" max="9" min="0"/>
                        <span class="position-absolute top-0 answer text-danger"></span>
                    </div>
                    <div class="col"></div>
                </div>
                <div class="row">
                    <div class="col"></div>
                    <div class="col"></div>
                    <div class="col border border-bottom border-1 border-light"></div>
                    <div class="col border border-bottom border-1 border-light"></div>
                    <div class="col border border-bottom border-1 border-light"></div>
                    <div class="col"></div>
                </div>
                <div class="row">
                    <div class="col"></div>
                    <div class="col"></div>
                    <div class="col"></div>
                    <div class="col position-relative border border-1 border-dashed border-secondary">
                        <input id="a3_2" type="number" class="bg-dark text-white form-control text-center border-0 p-0" pattern="[0-9]*" inputmode="numeric" maxlength="1" max="9" min="0"/>
                        <span class="position-absolute top-0 answer text-danger"></span>
                    </div>
                    <div class="col position-relative border border-1 border-dashed border-secondary">
                        <input id="a3_1" type="number" class="bg-dark text-white form-control text-center border-0 p-0" pattern="[0-9]*" inputmode="numeric" maxlength="1" max="9" min="0"/>
                        <span class="position-absolute top-0 answer text-danger"></span>
                    </div>
                    <div id="mark3" class="col"></div>
                </div>
                <div class="row border-top border-3 mt-1"></div>

            </div>
        </main>

        <footer class="mt-auto text-white-50">
            <div class="row py-3">
                <div class="col d-grid"><button id="prevQ" type="button" class="btn btn-success btn-lg btn-arrow">&lt;&lt;</button></div>
                <div class="col d-grid"><button id="nextQ" type="button" class="btn btn-success btn-lg btn-arrow">&gt;&gt;</button></div>
            </div>
            <div class="d-grid">
                <button id="btnSubmit" type="button" class="btn btn-primary btn-lg">SUBMIT</button>
            </div>
        </footer>
    </div>

    <div class="position-fixed top-0 start-0" style="z-index: 1000">
        <div id="toastReset" class="toast hide bg-white text-dark position-fixed top-50 start-50 translate-middle p-3" role="alert" aria-live="assertive"
            aria-atomic="true">
            <div class="toast-body">
                Reset?
                <div class="mt-2 pt-2 border-top">
                    <button id="btnResetYes" type="button" class="btn btn-danger px-3">Yes</button>
                    <button type="button" class="btn btn-secondary btn-close-toast px-5" data-bs-dismiss="toast">Cancel</button>
                </div>
            </div>
        </div>
        <div id="toastSubmitAll" class="toast hide bg-white text-dark position-fixed top-50 start-50 translate-middle p-3" role="alert" aria-live="assertive"
            aria-atomic="true">
            <div class="toast-body">
                Submit All?
                <div class="mt-2 pt-2 border-top">
                    <button id="btnSubmitAllYes" type="button" class="btn btn-success px-3">Yes</button>
                    <button type="button" class="btn btn-secondary btn-close-toast px-5" data-bs-dismiss="toast">Cancel</button>
                </div>
            </div>
        </div>
        <div id="toastSubmit" class="toast hide bg-white text-dark position-fixed top-50 start-50 translate-middle p-3" role="alert" aria-live="assertive"
            aria-atomic="true">
            <div class="toast-body">
                Submit?
                <div class="mt-2 pt-2 border-top">
                    <button id="btnSubmitYes" type="button" class="btn btn-success px-3">Yes</button>
                    <button type="button" class="btn btn-secondary btn-close-toast px-5" data-bs-dismiss="toast">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js" integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>

    <script>
        const start = 2;
        const end = 12;
        const lSize = 2;
        const qSize = 20;
        var currentQ = 0;
        var time = getTime();

        var qList = [];
        var aList = [];

        var stopTime = false;
        
        $(document).ready(function () {
            resizeFont();
            $("input").on("input", fixInput)
            $(window).resize(resetFont);

            init();
            
            $("#nextQ").click(nextQuestion)
            $("#prevQ").click(prevQuestion)
            
            
            $("#btnReset").click(function () {
                show($("#toastReset"))
            })
            $("#btnSubmit").click(function () {
                show($("#toastSubmit"))
            })
            $("#btnSubmitAll").click(function () {
                show($("#toastSubmitAll"))
            })
            $("#btnResetYes").click(function() {
                hide($(this).parents(".toast"));
                init();
            })
            $("#btnSubmitAllYes").click(function() {
                hide($(this).parents(".toast"))
                checkAnswerAll()
            });
            $("#btnSubmitYes").click(function() {
                hide($(this).parents(".toast"))
                checkAnswer()
            });

            $(".btn-close-toast").click(function () {
                hide($(this).parents(".toast"))
            })

            $(".num").click(setNumHint)
            
        });

        function init() {
            qList = [];
            aList = [];
            
            for (var i = 0; i < qSize; i++) {
                const q = [genNum(start, end), genNum(start, end)];
                q.unshift(q[0] * q[1])
                q.pop()
                q.push(genNum(0, q[1]))
                q[0] += q[2] 
                qList.push(q)
                aList.push({ a1: 0, a2: 0, a3: 0 })
            }

            time = getTime();
            stopTime = false;
            setTime();
            
            currentQ = 0
            setQuestion(currentQ);
            
            $(".toast").removeClass("show");
            $("#score").html("");
        }

        function nextQuestion() {
            currentQ++;
            if (currentQ >= qSize - 1) currentQ = qSize - 1;
            setQuestion(currentQ)
        }

        function prevQuestion() {
            currentQ--;
            if (currentQ <= 0) currentQ = 0;
            setQuestion(currentQ)
        }

        function setQuestion(num) {
            $(".num_hint").html("")
            $(".num").html("")

            const q = qList[num];

            q.forEach(function (qNum, i) {
                const qNumR = getReverseNum(qNum);
                qNumR.forEach(function (qCol, j) {
                    $("#l" + (i + 1) + "_" + (j + 1)).html(qCol);
                })
            })
            
            $(".btn-arrow").removeClass("d-none");
            if (currentQ >= qSize - 1) $("#nextQ").addClass("d-none");
            else if (currentQ === 0)   $("#prevQ").addClass("d-none");
            
            setAnswer();
            $("#posQ").html((currentQ + 1) + " / " + qSize)
        }

        function resetFont() {
            fs = 10;
            resizeFont();
        }

        var fs = 40;
        function resizeFont() {
            fs++;
            setFontSize(fs);
            if ($("#l1_1").width() > $("#l1_1").parent().width()) {
                fs--;
                setFontSize(fs);
                return;
            }
            if ($("#math-content").parent().height() + 1 < $("#math-content").parent()[0].scrollHeight) {
                fs--;
                setFontSize(fs);
                return;
            }
            if (fs < 1000) resizeFont();
        }

        function setFontSize(size) {
            var hSize = parseInt(size / 6)
            if (hSize < 20) hSize = 20;
            var nSize = parseInt(size / 10)
            if (nSize < 10) nSize = 10;
            $("#math-content").css({ 'font-size': size + "px" });
            $("#math-content input").css({ 'font-size': size + "px" });
            $("#timer").css({ 'font-size': hSize + "px" });
            $("#posQ").css({ 'font-size': hSize + "px" });
            $("#score").css({ 'font-size': hSize + "px" });
            $(".num_hint").css({ 'font-size': nSize + "px" });
            $(".answer").css({ 'font-size': parseInt(size/2) + "px" });
        }

        function fixInput(that) {
            $("#math-content input").each(function () {
                if ($(this).val() === "") return;
                if (parseInt($(this).val()) != $(this).val()) {
                    $(this).val(parseInt($(this).val()))
                }
                while ($(this).val().length > this.maxLength) {
                    $(this).val(parseInt($(this).val()/10))
                }
            });

            const el = $(that.currentTarget)[0];
            if (($(el).val() || "").length >= el.maxLength) {
                $(el).parent().next("div").children("input").focus();
            }
            saveAnswer();
        }

        function saveAnswer() {
            const a1 = [];
            const a2 = [];
            const a3 = [];
            for (var i = 1; i < 10; i++) {
                a1.push($("#a1_" + i).val() || 0)
                a2.push($("#a2_" + i).val() || 0)
                a3.push($("#a3_" + i).val() || 0)
            }
            aList[currentQ].a1 = parseInt(a1.reverse().join(""));
            aList[currentQ].a2 = parseInt(a2.reverse().join(""));
            aList[currentQ].a3 = parseInt(a3.reverse().join(""));
        }

        function setAnswer() {
            $("#math-content input").prop('readonly', false);
            $("#mark1").html("");
            $("#mark3").html("");

            const a1 = aList[currentQ].a1;
            var a1_1 = getDigit(a1, 1)
            var a1_2 = getDigit(a1, 2)
            var a1_3 = getDigit(a1, 3)

            if (!a1_3) a1_3 = "";
            $("#a1_3").val(a1_3);
            if (!a1_3 && !a1_2) a1_2 = ""
            $("#a1_2").val(a1_2);
            if (!a1_1 && !a1_2 && !a1_3) a1_1 = ""
            $("#a1_1").val(a1_1);

            const a2 = aList[currentQ].a2;
            var a2_1 = getDigit(a2, 1)
            var a2_2 = getDigit(a2, 2)
            var a2_3 = getDigit(a2, 3)

            if (!a2_3) a2_3 = "";
            $("#a2_3").val(a2_3);
            if (!a2_3 && !a2_2) a2_2 = ""
            $("#a2_2").val(a2_2);
            if (!a2_1 && !a2_2 && !a2_3) a2_1 = ""
            $("#a2_1").val(a2_1);

            const a3 = aList[currentQ].a3;
            var a3_1 = getDigit(a3, 1)
            var a3_2 = getDigit(a3, 2)
            var a3_3 = getDigit(a3, 3)

            if (!a3_3) a3_3 = "";
            $("#a3_3").val(a3_3);
            if (!a3_3 && !a3_2) a3_2 = ""
            $("#a3_2").val(a3_2);
            if (!a3_1 && !a3_2 && !a3_3) a3_1 = ""
            $("#a3_1").val(a3_1);

            $("#btnSubmit").prop('disabled', false);
            if (typeof aList[currentQ].m === "boolean")
                checkAnswer()
        }

        function checkAnswer() {
            saveAnswer();
            const q = qList[currentQ];
            const a1 = aList[currentQ].a1;
            const a3 = aList[currentQ].a3;
            const a = mathDiv2(q);

            if (a.a1 === a1) {
                $("#mark1").html("&check;").addClass("text-success").removeClass("text-danger")
                aList[currentQ].m1 = true;
            } else {
                $("#mark1").html("&cross;").addClass("text-danger").removeClass("text-success")
                aList[currentQ].m1 = false;
            }

            if (a.a3 === a3) {
                $("#mark3").html("&check;").addClass("text-success").removeClass("text-danger")
                aList[currentQ].m3 = true;
            } else {
                $("#mark3").html("&cross;").addClass("text-danger").removeClass("text-success")
                aList[currentQ].m3 = false;
            }

            if (aList[currentQ].m1 && aList[currentQ].m2) aList[currentQ].m = true;
            else aList[currentQ].m = false;

            $("#math-content input").prop('readonly', true);
            $("#btnSubmit").prop('disabled', true);
        }

        function checkAnswerAll() {
            checkAnswer();
            qList.forEach(function(q, i) {
                const a1 = aList[i].a1;
                const a3 = aList[i].a3;

                const a = mathDiv2(q);

                if (a.a1 === a1) aList[i].m1 = true;
                else aList[i].m1 = false;

                if (a.a3 === a3) aList[i].m3 = true;
                else aList[i].m3 = false;

                if (aList[i].m1 && aList[i].m3) aList[i].m = true;
                else  aList[i].m = false;
            })
            const c = aList.filter(function (a) {
                return a.m1 && a.m3;
            })

            const cp = parseInt((c.length * 100) / qSize);
            $("#score").html(cp + "%")
            $(".toast").removeClass("show")
            stopTime = true;
        }

        function getReverseNum(num) {
            const n = "" + (num || 0).toString()
            return n.split("").reverse()
        }

        function getDigit(num, digit) {
            const n = getReverseNum(num)
            return parseInt(n[digit - 1] || "")
        }

        function genNum(start, end) {
            return parseInt(Math.random() * (end - start + 1)) + start;
        }

        function setNumHint(that) {
            const currEl = that.currentTarget;
            const el = $(currEl).next(".num_hint");
            var num = (parseInt(el.html()) || 0) + 1
            num = num % 10;
            if (num === 0) num = ""
            el.html(num)
        }

        function mathSum(arr) {
            var t = 0;
            arr.forEach(function (i) {
                t += parseInt(i);
            })
            return t
        }

        function mathSub(arr) {
            var t = arr[0]*2;
            arr.forEach(function (i) {
                t -= parseInt(i);
            })
            return t
        }

        function mathMul(arr) {
            var t = 1;
            arr.forEach(function (i) {
                t *= parseInt(i);
            })
            return t
        }

        function mathDiv(arr) {
            var t = Math.pow(arr[0], 2);
            arr.forEach(function (i) {
                t /= parseInt(i);
            })
            return t
        }

        function mathDiv2(arr) {
            const a1 = parseInt(arr[0]/arr[1])
            const a3 = arr[0] % arr[1];
            return { a1, a3 }
        }

        function setTime() {
            if (stopTime) return;
            var s = parseInt((getTime() - time) / 1000);
            var m = parseInt(s/60);
            s = s % 60;
            var timer = m + ":" + ("00"+s).substr(-2);
            $("#timer").html(timer)

            setTimeout(setTime, 500);
        }

        function show(j) {
            j.show().addClass("show").removeClass("hide")
        }

        function hide(j) {
            j.hide().removeClass("show").addClass("hide")
        }

        function getTime() {
            return new Date().getTime();
        }
    </script>
</body>

</html>